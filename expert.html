<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Stage Check | No BS Camino</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <style>
        body { font-family: 'Google Sans', sans-serif; background-color: #f0f2f5; color: #202124; }
        .card-tactical { background-color: white; border: 1px solid #dadce0; border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); overflow: hidden; }
        #map { height: 250px; width: 100%; z-index: 1; border-bottom: 1px solid #eee; } 
        .chart-container { position: relative; height: 160px; width: 100%; margin-top: 10px; }
        .chart-label { font-size: 10px; fill: #5f6368; font-weight: 600; text-anchor: middle; }
        .temp-label { font-size: 11px; fill: #202124; font-weight: 700; text-anchor: middle; }
        /* Icons */
        .icon-sun { color: #fdb813; } .icon-rain { color: #1967d2; } .icon-gray { color: #5f6368; }
        .hidden-transition { display: none; }
    </style>
</head>
<body class="antialiased pb-24">

    <div id="installBanner" class="hidden bg-[#1967d2] text-white px-4 py-3 shadow-md flex justify-between items-center sticky top-0 z-[60]">
        <div class="flex items-center gap-3"><span class="font-bold text-sm">Get the App</span></div>
        <button id="installBtn" class="bg-white text-[#1967d2] px-3 py-1 rounded-full text-xs font-bold">Install</button>
    </div>

    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='index.html'">
                <svg class="w-6 h-6 text-[#1967d2]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <span class="font-bold text-gray-800 text-lg md:block hidden">No BS <span class="text-[#1967d2]">Daily Check</span></span>
            </div>
            <a href="weather.html" class="px-3 py-1 rounded-full border border-gray-300 text-xs font-bold text-gray-500 hover:bg-gray-50 transition-colors flex items-center">Full Planner</a>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-4">
        
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900 tracking-tight mb-2">Your Daily Stage Check</h1>
            <p class="text-gray-500 text-xs mb-6 px-4 leading-relaxed">Know exactly what to pack. Check weather, water stops, and safety risks for the path ahead.</p>
            <div class="flex justify-center gap-8 text-center mb-4">
                <div class="flex flex-col items-center"><div class="w-8 h-8 bg-white border border-gray-200 rounded-full flex items-center justify-center text-[#1967d2] mb-1 shadow-sm font-bold text-xs">1</div><span class="text-[10px] font-bold text-gray-400 uppercase">Find Loc</span></div>
                <div class="flex flex-col items-center"><div class="w-8 h-8 bg-white border border-gray-200 rounded-full flex items-center justify-center text-[#1967d2] mb-1 shadow-sm font-bold text-xs">2</div><span class="text-[10px] font-bold text-gray-400 uppercase">Scan Path</span></div>
                <div class="flex flex-col items-center"><div class="w-8 h-8 bg-white border border-gray-200 rounded-full flex items-center justify-center text-[#1967d2] mb-1 shadow-sm"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></div><span class="text-[10px] font-bold text-gray-400 uppercase">Pack Smart</span></div>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200 p-3 mb-6 shadow-sm relative">
            
            <div id="heroControls" class="absolute inset-0 z-[1000] bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center p-6 rounded-xl text-center hidden">
                <button onclick="locateUser()" class="w-full bg-[#1967d2] hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl text-base shadow-lg transition-all flex justify-center items-center gap-2 mb-3 transform hover:scale-105">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Locate Me
                </button>
                <button onclick="enableManualMode()" class="text-xs font-bold text-gray-400 hover:text-[#1967d2] underline decoration-dashed">
                    Not on the trail? Select manually
                </button>
            </div>

            <div id="activeControls" class="mb-3 hidden-transition">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Route & Stage</label>
                <select id="routeSelect" onchange="changeRoute()" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-gray-800 font-bold text-sm focus:outline-none focus:border-[#1967d2]">
                    <option value="frances">Camino Franc√©s</option>
                    <option value="norte">Camino del Norte</option>
                    <option value="plata">Via de la Plata</option>
                    <option value="lusitana">Via Lusitana</option>
                    <option value="coastal">Portuguese Coastal</option>
                    <option value="primitivo">Camino Primitivo</option>
                    <option value="invierno">Camino de Invierno</option>
                </select>
            </div>
            
            <div class="relative rounded-xl overflow-hidden border border-gray-200 h-48">
                <div id="map"></div>
                <div id="mapOverlay" class="absolute bottom-2 left-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-[10px] font-bold text-gray-600 shadow-sm z-[999] hidden-transition">
                    üìç <span id="currentStageName">Select a stage on map</span>
                </div>
            </div>
            
            <button id="scanBtn" onclick="getTacticalForecast()" class="w-full mt-3 bg-[#1967d2] hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg text-sm shadow-md transition-all flex justify-center items-center gap-2 hidden-transition">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                Scan Next 3 Days
            </button>
        </div>

        <div id="loading" class="hidden text-center py-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#1967d2] mx-auto"></div>
            <p class="text-xs text-gray-400 mt-3 font-medium">Checking weather & safety risks...</p>
        </div>
        
        <div id="results" class="space-y-6 pb-20"></div>

    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script>
        // --- COMPLETE ROUTE DATA ---
        const routes = {
            frances: {
                name: "Camino Franc√©s", center: [42.6, -4.0], zoom: 6, color: '#dc2626',
                stages: [
                    { start: "St-Jean", end: "Roncesvalles", dist: "24.2 km", lat: 43.05, lon: -1.27, water: 12, bailout: "Low", sRisk: "High UV/Exposure", wRisk: "Closed / Snow" },
                    { start: "Roncesvalles", end: "Zubiri", dist: "22 km", lat: 42.96, lon: -1.45, water: 5, bailout: "Med", sRisk: "Heat in valley", wRisk: "Mud / Ice" },
                    { start: "Zubiri", end: "Pamplona", dist: "19.8 km", lat: 42.86, lon: -1.58, water: 5, bailout: "Med", sRisk: "Urban heat (PM)", wRisk: "River flooding" },
                    { start: "Pamplona", end: "Puente la Reina", dist: "24.3 km", lat: 42.74, lon: -1.74, water: 8, bailout: "High", sRisk: "Alto del Perd√≥n (sun)", wRisk: "Windy on ridge" },
                    { start: "Puente la Reina", end: "Estella", dist: "23.3 km", lat: 42.67, lon: -1.92, water: 5, bailout: "Med", sRisk: "Dry heat", wRisk: "Clay mud" },
                    { start: "Estella", end: "Torres del R√≠o", dist: "29 km", lat: 42.58, lon: -2.18, water: 5, bailout: "Med", sRisk: "Long exposed stretches", wRisk: "Cold mornings" },
                    { start: "Torres del R√≠o", end: "Logro√±o", dist: "21.1 km", lat: 42.49, lon: -2.35, water: 5, bailout: "Med", sRisk: "Urban heat", wRisk: "Cold wind" },
                    { start: "Logro√±o", end: "N√°jera", dist: "30.1 km", lat: 42.43, lon: -2.62, water: 5, bailout: "Med", sRisk: "Very High Heat", wRisk: "Cold winds" },
                    { start: "N√°jera", end: "Gra√±√≥n", dist: "28.8 km", lat: 42.40, lon: -2.91, water: 5, bailout: "Med", sRisk: "Exposed fields", wRisk: "Snow possible" },
                    { start: "Gra√±√≥n", end: "Belorado", dist: "17 km", lat: 42.41, lon: -3.10, water: 5, bailout: "Med", sRisk: "Easy day", wRisk: "Cold / Ice" },
                    { start: "Belorado", end: "San Juan de Ortega", dist: "24.8 km", lat: 42.39, lon: -3.34, water: 5, bailout: "Med", sRisk: "Sun in Montes de Oca", wRisk: "Snow Risk" },
                    { start: "San Juan de Ortega", end: "Burgos", dist: "30.4 km", lat: 42.36, lon: -3.58, water: 10, bailout: "Med", sRisk: "Urban asphalt heat", wRisk: "Cold/Wind" },
                    { start: "Burgos", end: "Hontanas", dist: "29.8 km", lat: 42.33, lon: -3.92, water: 10, bailout: "Med", sRisk: "Meseta Heat", wRisk: "Freezing wind" },
                    { start: "Hontanas", end: "Ermita San Nicol√°s", dist: "18.7 km", lat: 42.31, lon: -4.13, water: 10, bailout: "Med", sRisk: "No Shade", wRisk: "Muddy tracks" },
                    { start: "Ermita San Nicol√°s", end: "Villalc√°zar", dist: "29.9 km", lat: 42.31, lon: -4.43, water: 10, bailout: "Med", sRisk: "Meseta Heat", wRisk: "Exposed wind" },
                    { start: "Villalc√°zar", end: "Calzadilla Cueza", dist: "23.3 km", lat: 42.35, lon: -4.71, water: 17, bailout: "Low", sRisk: "The 17km Gap", wRisk: "Harsh winds" },
                    { start: "Calzadilla Cueza", end: "Sahag√∫n", dist: "24.8 km", lat: 42.37, lon: -4.95, water: 10, bailout: "Med", sRisk: "Heat", wRisk: "Ice" },
                    { start: "Sahag√∫n", end: "Reliegos", dist: "31.1 km", lat: 42.47, lon: -5.25, water: 10, bailout: "Med", sRisk: "Long/Flat/Boring", wRisk: "Cold plateau" },
                    { start: "Reliegos", end: "Le√≥n", dist: "29.9 km", lat: 42.55, lon: -5.48, water: 10, bailout: "Med", sRisk: "Urban heat", wRisk: "Cold" },
                    { start: "Le√≥n", end: "Hospital de √ìrbigo", dist: "32 km", lat: 42.53, lon: -5.84, water: 5, bailout: "Med", sRisk: "Roadside heat", wRisk: "Traffic spray" },
                    { start: "Hospital de √ìrbigo", end: "Sta. Catalina", dist: "26.5 km", lat: 42.48, lon: -6.11, water: 5, bailout: "Med", sRisk: "Gradual ascent heat", wRisk: "Cold nights" },
                    { start: "Sta. Catalina", end: "El Acebo", dist: "33.9 km", lat: 42.50, lon: -6.38, water: 5, bailout: "Med", sRisk: "Mountain Sun", wRisk: "Heavy Snow" },
                    { start: "El Acebo", end: "Ponferrada", dist: "18.1 km", lat: 42.53, lon: -6.55, water: 5, bailout: "Med", sRisk: "Knee stress (descent)", wRisk: "Ice on rocks" },
                    { start: "Ponferrada", end: "Villafranca", dist: "25.5 km", lat: 42.58, lon: -6.74, water: 5, bailout: "Med", sRisk: "Vineyard heat", wRisk: "Damp" },
                    { start: "Villafranca", end: "O Cebreiro", dist: "27.5 km", lat: 42.70, lon: -7.05, water: 8, bailout: "Low", sRisk: "Hard Climb", wRisk: "Snow/Blizzard" },
                    { start: "O Cebreiro", end: "Triacastela", dist: "21.5 km", lat: 42.73, lon: -7.18, water: 5, bailout: "Med", sRisk: "Ridge sun", wRisk: "Ice/Wind" },
                    { start: "Triacastela", end: "Barbadelo", dist: "23.7 km", lat: 42.77, lon: -7.38, water: 5, bailout: "Med", sRisk: "Humid heat", wRisk: "Muddy paths" },
                    { start: "Barbadelo", end: "Gonzar", dist: "26.2 km", lat: 42.82, lon: -7.58, water: 5, bailout: "Med", sRisk: "Humid", wRisk: "Mud" },
                    { start: "Gonzar", end: "Melide", dist: "31.4 km", lat: 42.88, lon: -7.88, water: 5, bailout: "Med", sRisk: "Long day", wRisk: "Mud" },
                    { start: "Melide", end: "Santa Irene", dist: "30.7 km", lat: 42.92, lon: -8.22, water: 5, bailout: "Med", sRisk: "Eucalpytus shade", wRisk: "Mud" },
                    { start: "Santa Irene", end: "Santiago", dist: "25.3 km", lat: 42.90, lon: -8.45, water: 5, bailout: "Med", sRisk: "Emotional fatigue", wRisk: "Rain" }
                ]
            },
            norte: {
                name: "Camino del Norte", center: [43.4, -4.0], zoom: 7, color: '#16a34a',
                stages: [
                    { start: "Bayonne", end: "St-Jean-de-Luz", dist: "26 km", lat: 43.43, lon: -1.55, water: 5, bailout: "Med", sRisk: "High humidity", wRisk: "Rain/Wind" },
                    { start: "St-Jean-de-Luz", end: "Ir√∫n", dist: "15.9 km", lat: 43.36, lon: -1.73, water: 5, bailout: "Med", sRisk: "Traffic on road", wRisk: "Slippery cliff path" },
                    { start: "Ir√∫n", end: "San Sebasti√°n", dist: "24.5 km", lat: 43.32, lon: -1.90, water: 12, bailout: "Low", sRisk: "Heat on Jaizkibel", wRisk: "Mud on descent" },
                    { start: "San Sebasti√°n", end: "Zarautz", dist: "22.3 km", lat: 43.29, lon: -2.10, water: 5, bailout: "Med", sRisk: "No shade on climb", wRisk: "Slippery stones" },
                    { start: "Zarautz", end: "Deba", dist: "26 km", lat: 43.29, lon: -2.30, water: 5, bailout: "Med", sRisk: "Exposed vineyards", wRisk: "Heavy Mud" },
                    { start: "Deba", end: "Markina", dist: "25 km", lat: 43.27, lon: -2.45, water: 5, bailout: "Med", sRisk: "Heat in hills", wRisk: "Deep Mud" },
                    { start: "Markina", end: "Gernika", dist: "26.5 km", lat: 43.28, lon: -2.60, water: 5, bailout: "Med", sRisk: "Humid forest", wRisk: "Slippery clay" },
                    { start: "Gernika", end: "Lezama", dist: "20 km", lat: 43.28, lon: -2.75, water: 5, bailout: "Med", sRisk: "Asphalt heat", wRisk: "Muddy tracks" },
                    { start: "Lezama", end: "Bilbao", dist: "11.5 km", lat: 43.26, lon: -2.90, water: 5, bailout: "Med", sRisk: "Urban heat island", wRisk: "Wet cobbles" },
                    { start: "Bilbao", end: "Portugalete", dist: "19 km", lat: 43.30, lon: -3.00, water: 5, bailout: "Med", sRisk: "Industrial pollution", wRisk: "River damp" },
                    { start: "Portugalete", end: "Castro-Urdiales", dist: "25.7 km", lat: 43.35, lon: -3.15, water: 5, bailout: "Med", sRisk: "Road walking heat", wRisk: "Rain exposure" },
                    { start: "Castro-Urdiales", end: "Liendo", dist: "20 km", lat: 43.38, lon: -3.30, water: 5, bailout: "Med", sRisk: "Highway noise", wRisk: "Mud" },
                    { start: "Liendo", end: "Santo√±a", dist: "12.5 km", lat: 43.43, lon: -3.45, water: 5, bailout: "Med", sRisk: "Ferry timing risk", wRisk: "Ferry closed" },
                    { start: "Santo√±a", end: "G√ºemes", dist: "20.6 km", lat: 43.45, lon: -3.55, water: 5, bailout: "Med", sRisk: "No shade (beach)", wRisk: "Cold wind" },
                    { start: "G√ºemes", end: "Santander", dist: "11 km", lat: 43.44, lon: -3.75, water: 5, bailout: "Med", sRisk: "Boat schedule", wRisk: "Rain" },
                    { start: "Santander", end: "Mogro", dist: "24 km", lat: 43.43, lon: -3.90, water: 5, bailout: "Med", sRisk: "Confusing exit", wRisk: "Industrial mud" },
                    { start: "Mogro", end: "Santillana", dist: "21 km", lat: 43.40, lon: -4.05, water: 5, bailout: "Med", sRisk: "Asphalt heat", wRisk: "Slippery pipes" },
                    { start: "Santillana", end: "Comillas", dist: "22.7 km", lat: 43.39, lon: -4.20, water: 5, bailout: "Med", sRisk: "Road traffic", wRisk: "Wind" },
                    { start: "Comillas", end: "Serdio", dist: "18.5 km", lat: 43.37, lon: -4.40, water: 5, bailout: "Med", sRisk: "Exposed road", wRisk: "Mud" },
                    { start: "Serdio", end: "Llanes", dist: "33.7 km", lat: 43.40, lon: -4.60, water: 5, bailout: "Med", sRisk: "Long distance", wRisk: "Rain/Wind" },
                    { start: "Llanes", end: "Nueva", dist: "18 km", lat: 43.42, lon: -4.85, water: 5, bailout: "Med", sRisk: "Busy roads", wRisk: "Mud paths" },
                    { start: "Nueva", end: "Ribadesella", dist: "13.5 km", lat: 43.45, lon: -5.00, water: 5, bailout: "Med", sRisk: "Beach heat", wRisk: "Damp" },
                    { start: "Ribadesella", end: "La Isla", dist: "18 km", lat: 43.48, lon: -5.15, water: 5, bailout: "Med", sRisk: "Steep ups/downs", wRisk: "Slippery grass" },
                    { start: "La Isla", end: "Villaviciosa", dist: "21.8 km", lat: 43.50, lon: -5.35, water: 5, bailout: "Med", sRisk: "Eucalyptus heat", wRisk: "Heavy Mud" },
                    { start: "Villaviciosa", end: "Gij√≥n", dist: "30 km", lat: 43.52, lon: -5.55, water: 5, bailout: "Med", sRisk: "Alto de la Cruz", wRisk: "Snow (rare)" },
                    { start: "Gij√≥n", end: "Avil√©s", dist: "25 km", lat: 43.55, lon: -5.80, water: 5, bailout: "Med", sRisk: "Industrial smog", wRisk: "Cold rain" },
                    { start: "Avil√©s", end: "Muros de Nal√≥n", dist: "23.5 km", lat: 43.55, lon: -6.05, water: 5, bailout: "Med", sRisk: "Suburban tarmac", wRisk: "Mud" },
                    { start: "Muros", end: "Soto de Lui√±a", dist: "15.5 km", lat: 43.56, lon: -6.20, water: 5, bailout: "Med", sRisk: "Humid woods", wRisk: "Slippery stone" },
                    { start: "Soto", end: "Cadavedo", dist: "18.4 km", lat: 43.55, lon: -6.35, water: 5, bailout: "Med", sRisk: "Ballotas (steep)", wRisk: "Landslides" },
                    { start: "Cadavedo", end: "Luarca", dist: "16.6 km", lat: 43.54, lon: -6.50, water: 5, bailout: "Med", sRisk: "Road exposure", wRisk: "Rain" },
                    { start: "Luarca", end: "La Caridad", dist: "32 km", lat: 43.54, lon: -6.70, water: 5, bailout: "Med", sRisk: "Long/Exposed", wRisk: "Wind/Rain" },
                    { start: "La Caridad", end: "Ribadeo", dist: "22 km", lat: 43.54, lon: -6.95, water: 5, bailout: "Med", sRisk: "Bridge wind", wRisk: "Cold damp" },
                    { start: "Ribadeo", end: "Lourenz√°", dist: "27.8 km", lat: 43.45, lon: -7.20, water: 5, bailout: "Med", sRisk: "Inland heat shift", wRisk: "Fog" },
                    { start: "Lourenz√°", end: "Abad√≠n", dist: "27 km", lat: 43.35, lon: -7.40, water: 5, bailout: "Med", sRisk: "Mondo√±edo climb", wRisk: "Fog/Cold" },
                    { start: "Abad√≠n", end: "Vilalba", dist: "20 km", lat: 43.30, lon: -7.60, water: 5, bailout: "Med", sRisk: "Flat/Boring", wRisk: "Cold winds" },
                    { start: "Vilalba", end: "Baamonde", dist: "20.6 km", lat: 43.20, lon: -7.70, water: 5, bailout: "Med", sRisk: "Roadside heat", wRisk: "Mud" },
                    { start: "Baamonde", end: "Sobrado", dist: "40.3 km", lat: 43.10, lon: -7.90, water: 15, bailout: "Low", sRisk: "EXTREME DISTANCE", wRisk: "Snow/Ice" },
                    { start: "Sobrado", end: "O Pedrouzo", dist: "37.7 km", lat: 42.95, lon: -8.30, water: 5, bailout: "Med", sRisk: "Long distance", wRisk: "Mud" },
                    { start: "O Pedrouzo", end: "Santiago", dist: "20.1 km", lat: 42.90, lon: -8.50, water: 5, bailout: "Med", sRisk: "Crowds/Sun", wRisk: "Rain" }
                ]
            },
            plata: {
                name: "V√≠a de la Plata", center: [39.5, -6.0], zoom: 6, color: '#eab308',
                stages: [
                    { start: "Sevilla", end: "Guillena", dist: "22.6 km", lat: 37.47, lon: -6.02, water: 5, bailout: "Med", sRisk: "Extreme Heat", wRisk: "Mud (industrial)" },
                    { start: "Guillena", end: "Castilblanco", dist: "18 km", lat: 37.60, lon: -6.01, water: 5, bailout: "Med", sRisk: "No Shade / Heat", wRisk: "Road walking" },
                    { start: "Castilblanco", end: "Almad√©n", dist: "29.5 km", lat: 37.78, lon: -6.00, water: 20, bailout: "Zero", sRisk: "Park Restriction", wRisk: "Muddy trails" },
                    { start: "Almad√©n", end: "El Real", dist: "15.4 km", lat: 37.90, lon: -6.10, water: 5, bailout: "Med", sRisk: "Heat", wRisk: "Rain" },
                    { start: "El Real", end: "Monesterio", dist: "19.8 km", lat: 38.02, lon: -6.20, water: 5, bailout: "Med", sRisk: "Dry Heat", wRisk: "Cold wind" },
                    { start: "Monesterio", end: "F. de Cantos", dist: "21.6 km", lat: 38.16, lon: -6.25, water: 5, bailout: "Med", sRisk: "Exposed fields", wRisk: "Wind" },
                    { start: "F. de Cantos", end: "Zafra", dist: "25.1 km", lat: 38.32, lon: -6.35, water: 5, bailout: "Med", sRisk: "No Shade", wRisk: "Mud" },
                    { start: "Zafra", end: "Villafranca", dist: "18.9 km", lat: 38.48, lon: -6.38, water: 5, bailout: "Med", sRisk: "Dust/Heat", wRisk: "Muddy vines" },
                    { start: "Villafranca", end: "Torremej√≠a", dist: "27.4 km", lat: 38.68, lon: -6.38, water: 27, bailout: "High", sRisk: "Zero Shade", wRisk: "Wind" },
                    { start: "Torremej√≠a", end: "M√©rida", dist: "15.6 km", lat: 38.85, lon: -6.35, water: 5, bailout: "Med", sRisk: "River heat", wRisk: "Rain" },
                    { start: "M√©rida", end: "Aljuc√©n", dist: "15.9 km", lat: 39.00, lon: -6.35, water: 5, bailout: "Med", sRisk: "Easy day", wRisk: "Mud" },
                    { start: "Aljuc√©n", end: "Alcu√©scar", dist: "20.1 km", lat: 39.10, lon: -6.25, water: 5, bailout: "Med", sRisk: "Park heat", wRisk: "Mud" },
                    { start: "Alcu√©scar", end: "Valdesalor", dist: "25.7 km", lat: 39.25, lon: -6.25, water: 5, bailout: "Med", sRisk: "Exposed", wRisk: "Wind" },
                    { start: "Valdesalor", end: "Casar", dist: "21.8 km", lat: 39.40, lon: -6.35, water: 5, bailout: "Med", sRisk: "City transit", wRisk: "City transit" },
                    { start: "Casar", end: "Ca√±averal", dist: "33 km", lat: 39.65, lon: -6.40, water: 5, bailout: "Med", sRisk: "No Water/Shade", wRisk: "Mud" },
                    { start: "Ca√±averal", end: "Galisteo", dist: "29.3 km", lat: 39.88, lon: -6.38, water: 5, bailout: "Med", sRisk: "Road heat", wRisk: "Wind" },
                    { start: "Galisteo", end: "Carcaboso", dist: "11.5 km", lat: 40.00, lon: -6.30, water: 5, bailout: "Med", sRisk: "Short day", wRisk: "Rain" },
                    { start: "Carcaboso", end: "C√°parra", dist: "40 km", lat: 40.11, lon: -6.15, water: 30, bailout: "Zero", sRisk: "Dangerous Heat", wRisk: "Boggy" },
                    { start: "C√°parra", end: "Calzada", dist: "22.5 km", lat: 40.25, lon: -5.95, water: 5, bailout: "Med", sRisk: "Ascent heat", wRisk: "Cold" },
                    { start: "Calzada", end: "Fuenterroble", dist: "20.3 km", lat: 40.45, lon: -5.85, water: 5, bailout: "Med", sRisk: "Plateau sun", wRisk: "Snow/Ice" },
                    { start: "Fuenterroble", end: "San Pedro", dist: "29.9 km", lat: 40.65, lon: -5.75, water: 5, bailout: "Med", sRisk: "Pico Due√±as Sun", wRisk: "Snow" },
                    { start: "San Pedro", end: "Salamanca", dist: "23.1 km", lat: 40.85, lon: -5.70, water: 5, bailout: "Med", sRisk: "No shade", wRisk: "Cold wind" },
                    { start: "Salamanca", end: "Valdunciel", dist: "15 km", lat: 41.05, lon: -5.65, water: 5, bailout: "Med", sRisk: "Easy exit", wRisk: "Cold" },
                    { start: "Valdunciel", end: "El Cubo", dist: "20 km", lat: 41.15, lon: -5.68, water: 5, bailout: "Med", sRisk: "Boring/Flat", wRisk: "Wind" },
                    { start: "El Cubo", end: "Zamora", dist: "31.7 km", lat: 41.35, lon: -5.75, water: 5, bailout: "Med", sRisk: "Heat Exhaustion", wRisk: "Cold" },
                    { start: "Zamora", end: "Montamarta", dist: "18.3 km", lat: 41.58, lon: -5.80, water: 5, bailout: "Med", sRisk: "Highway noise", wRisk: "Mud" },
                    { start: "Montamarta", end: "Granja", dist: "22.5 km", lat: 41.75, lon: -5.78, water: 5, bailout: "Med", sRisk: "Exposed", wRisk: "Mud (Reserva)" },
                    { start: "Granja", end: "T√°bara", dist: "25.6 km", lat: 41.85, lon: -5.95, water: 5, bailout: "Med", sRisk: "Scrubland heat", wRisk: "Cold" },
                    { start: "T√°bara", end: "Santa Marta", dist: "22.8 km", lat: 41.95, lon: -6.05, water: 5, bailout: "Med", sRisk: "River Tera heat", wRisk: "Cold" },
                    { start: "Santa Marta", end: "Mombuey", dist: "35.2 km", lat: 42.05, lon: -6.20, water: 5, bailout: "Med", sRisk: "Long/Exposed", wRisk: "Cold" },
                    { start: "Mombuey", end: "Puebla", dist: "31.8 km", lat: 42.08, lon: -6.50, water: 5, bailout: "Med", sRisk: "Forest Fire risk", wRisk: "Snow" },
                    { start: "Puebla", end: "Lubi√°n", dist: "29.5 km", lat: 42.05, lon: -6.85, water: 5, bailout: "Med", sRisk: "Mountain Sun", wRisk: "Snow/Ice" },
                    { start: "Lubi√°n", end: "A Gudi√±a", dist: "25.7 km", lat: 42.06, lon: -7.10, water: 5, bailout: "Med", sRisk: "Padornelo Pass", wRisk: "Closed Pass" },
                    { start: "A Gudi√±a", end: "Laza", dist: "35 km", lat: 42.05, lon: -7.40, water: 20, bailout: "Low", sRisk: "Heat/Remote", wRisk: "Ice" },
                    { start: "Laza", end: "Xunqueira", dist: "33 km", lat: 42.15, lon: -7.60, water: 5, bailout: "Med", sRisk: "Alberguer√≠a climb", wRisk: "Mud" },
                    { start: "Xunqueira", end: "Ourense", dist: "22.5 km", lat: 42.25, lon: -7.80, water: 5, bailout: "Med", sRisk: "Ind. zone heat", wRisk: "Rain" },
                    { start: "Ourense", end: "Cea", dist: "22.5 km", lat: 42.38, lon: -7.98, water: 5, bailout: "Med", sRisk: "The Oven", wRisk: "Rain" },
                    { start: "Cea", end: "Castro Doz√≥n", dist: "19.5 km", lat: 42.50, lon: -8.02, water: 5, bailout: "Med", sRisk: "Monastery detour", wRisk: "Rain" },
                    { start: "Castro", end: "Silleda", dist: "28 km", lat: 42.65, lon: -8.15, water: 5, bailout: "Med", sRisk: "Rolling hills", wRisk: "Rain/Mud" },
                    { start: "Silleda", end: "Ponte Ulla", dist: "19.6 km", lat: 42.78, lon: -8.35, water: 5, bailout: "Med", sRisk: "Descent", wRisk: "Rain" },
                    { start: "Ponte Ulla", end: "Santiago", dist: "20.5 km", lat: 42.82, lon: -8.50, water: 5, bailout: "Med", sRisk: "Final climb", wRisk: "Rain" }
                ]
            },
            lusitana: {
                name: "Via Lusitana", center: [40.5, -8.5], zoom: 7, color: '#f59e0b',
                stages: [
                    { start: "Lisboa", end: "Alverca", dist: "31 km", lat: 38.80, lon: -9.05, water: 5, bailout: "Med", sRisk: "Urban heat/Smog", wRisk: "Rain puddles" },
                    { start: "Alverca", end: "Azambuja", dist: "32 km", lat: 39.00, lon: -8.90, water: 5, bailout: "Med", sRisk: "No Shade", wRisk: "Muddy paths" },
                    { start: "Azambuja", end: "Santar√©m", dist: "35 km", lat: 39.15, lon: -8.75, water: 5, bailout: "Med", sRisk: "Heat/Dust", wRisk: "Flooding" },
                    { start: "Santar√©m", end: "Arneiro", dist: "27 km", lat: 39.30, lon: -8.70, water: 5, bailout: "Med", sRisk: "Exposed olive trees", wRisk: "Mud" },
                    { start: "Arneiro", end: "Minde", dist: "20 km", lat: 39.45, lon: -8.65, water: 5, bailout: "Med", sRisk: "Limestone glare", wRisk: "Slippery stone" },
                    { start: "Minde", end: "F√°tima", dist: "25 km", lat: 39.55, lon: -8.65, water: 5, bailout: "Med", sRisk: "Steep climb", wRisk: "Fog/Cold" },
                    { start: "F√°tima", end: "Caxarias", dist: "26 km", lat: 39.70, lon: -8.60, water: 5, bailout: "Med", sRisk: "Forest fire risk", wRisk: "Mud" },
                    { start: "Caxarias", end: "Ansi√£o", dist: "33 km", lat: 39.85, lon: -8.55, water: 5, bailout: "Med", sRisk: "Long day", wRisk: "Mud" },
                    { start: "Ansi√£o", end: "Condeixa", dist: "32 km", lat: 40.00, lon: -8.50, water: 5, bailout: "Low", sRisk: "Heat", wRisk: "Rain" },
                    { start: "Condeixa", end: "Coimbra", dist: "16 km", lat: 40.15, lon: -8.45, water: 5, bailout: "Med", sRisk: "Urban heat", wRisk: "Rain" },
                    { start: "Coimbra", end: "Sernadelo", dist: "27 km", lat: 40.30, lon: -8.45, water: 5, bailout: "Med", sRisk: "Road walking", wRisk: "Spray/Traffic" },
                    { start: "Sernadelo", end: "√Ågueda", dist: "29 km", lat: 40.45, lon: -8.45, water: 5, bailout: "Med", sRisk: "Asphalt", wRisk: "Rain" },
                    { start: "√Ågueda", end: "Albergaria", dist: "18 km", lat: 40.65, lon: -8.48, water: 5, bailout: "Med", sRisk: "Eucalypt heat", wRisk: "Mud" },
                    { start: "Albergaria", end: "S. Jo√£o", dist: "34 km", lat: 40.80, lon: -8.50, water: 5, bailout: "Low", sRisk: "Long/Industrial", wRisk: "Traffic" },
                    { start: "S. Jo√£o", end: "Porto", dist: "44 km", lat: 41.00, lon: -8.60, water: 5, bailout: "Low", sRisk: "Too Long", wRisk: "Rain" },
                    { start: "Porto", end: "Vilarinho", dist: "26 km", lat: 41.25, lon: -8.65, water: 5, bailout: "Med", sRisk: "Urban sprawl", wRisk: "Wet cobbles" },
                    { start: "Vilarinho", end: "Barcelos", dist: "30 km", lat: 41.45, lon: -8.62, water: 5, bailout: "Low", sRisk: "Road heat", wRisk: "Rain" },
                    { start: "Barcelos", end: "Ponte Lima", dist: "34 km", lat: 41.65, lon: -8.58, water: 5, bailout: "Med", sRisk: "Cornfield Heat", wRisk: "Mud" },
                    { start: "Ponte Lima", end: "Rubi√£es", dist: "19 km", lat: 41.90, lon: -8.60, water: 5, bailout: "Low", sRisk: "Labruja Climb", wRisk: "Slippery rocks" },
                    { start: "Rubi√£es", end: "Tui", dist: "20 km", lat: 42.00, lon: -8.64, water: 5, bailout: "Med", sRisk: "Descent", wRisk: "Rain" },
                    { start: "Tui", end: "O Porri√±o", dist: "18 km", lat: 42.10, lon: -8.62, water: 5, bailout: "Med", sRisk: "Ind. Zone Heat", wRisk: "Flooded track" },
                    { start: "O Porri√±o", end: "Redondela", dist: "16 km", lat: 42.22, lon: -8.61, water: 5, bailout: "Med", sRisk: "Road heat", wRisk: "Rain" },
                    { start: "Redondela", end: "Pontevedra", dist: "20 km", lat: 42.35, lon: -8.64, water: 5, bailout: "Low", sRisk: "Easy hills", wRisk: "Rain" },
                    { start: "Pontevedra", end: "Caldas", dist: "23 km", lat: 42.52, lon: -8.65, water: 5, bailout: "Med", sRisk: "No shade", wRisk: "Mud" },
                    { start: "Caldas", end: "Padr√≥n", dist: "19 km", lat: 42.68, lon: -8.66, water: 5, bailout: "Med", sRisk: "Humid/Forest", wRisk: "Rain" },
                    { start: "Padr√≥n", end: "Santiago", dist: "25 km", lat: 42.80, lon: -8.60, water: 5, bailout: "Med", sRisk: "Urban approach", wRisk: "Rain" }
                ]
            },
            coastal: {
                name: "Portuguese Coastal", center: [41.8, -8.8], zoom: 8, color: '#3b82f6',
                stages: [
                    { start: "Porto", end: "Labruge", dist: "24.5 km", lat: 41.22, lon: -8.70, water: 5, bailout: "High", sRisk: "Sunburn (Sand)", wRisk: "Wind/Spray" },
                    { start: "Labruge", end: "P√≥voa", dist: "16.2 km", lat: 41.35, lon: -8.75, water: 5, bailout: "High", sRisk: "No Shade", wRisk: "Wind" },
                    { start: "P√≥voa", end: "Esposende", dist: "20.2 km", lat: 41.48, lon: -8.78, water: 8, bailout: "High", sRisk: "Cobbles/Heat", wRisk: "Wind" },
                    { start: "Esposende", end: "Viana", dist: "25.5 km", lat: 41.65, lon: -8.82, water: 8, bailout: "High", sRisk: "Inland Heat", wRisk: "Mud" },
                    { start: "Viana", end: "Caminha", dist: "26.8 km", lat: 41.80, lon: -8.85, water: 10, bailout: "High", sRisk: "Exposed Coast", wRisk: "Storm Surge" },
                    { start: "Caminha", end: "Moug√°s", dist: "23.5 km", lat: 41.95, lon: -8.88, water: 10, bailout: "Low", sRisk: "Ferry Wait", wRisk: "Ferry Closed" },
                    { start: "Moug√°s", end: "Ramallosa", dist: "16.4 km", lat: 42.08, lon: -8.85, water: 5, bailout: "High", sRisk: "Road walking", wRisk: "Wind" },
                    { start: "Ramallosa", end: "Vigo", dist: "20.1 km", lat: 42.20, lon: -8.75, water: 5, bailout: "High", sRisk: "Urban Heat", wRisk: "Traffic" },
                    { start: "Vigo", end: "Redondela", dist: "16.5 km", lat: 42.28, lon: -8.65, water: 5, bailout: "High", sRisk: "Steep Senda", wRisk: "Mud" },
                    { start: "Redondela", end: "Pontevedra", dist: "20 km", lat: 42.35, lon: -8.64, water: 5, bailout: "Low", sRisk: "Easy hills", wRisk: "Rain" },
                    { start: "Pontevedra", end: "Caldas", dist: "23 km", lat: 42.52, lon: -8.65, water: 5, bailout: "Med", sRisk: "No shade", wRisk: "Mud" },
                    { start: "Caldas", end: "Padr√≥n", dist: "19 km", lat: 42.68, lon: -8.66, water: 5, bailout: "High", sRisk: "Humid/Forest", wRisk: "Rain" },
                    { start: "Padr√≥n", end: "Santiago", dist: "25 km", lat: 42.80, lon: -8.60, water: 5, bailout: "Med", sRisk: "Urban approach", wRisk: "Rain" }
                ]
            },
            primitivo: {
                name: "Camino Primitivo", center: [43.2, -6.5], zoom: 8, color: '#8b5cf6',
                stages: [
                    { start: "Oviedo", end: "Grado", dist: "25.8 km", lat: 43.38, lon: -5.95, water: 5, bailout: "High", sRisk: "Humid Heat", wRisk: "Deep Mud" },
                    { start: "Grado", end: "Salas", dist: "22.5 km", lat: 43.40, lon: -6.15, water: 8, bailout: "Med", sRisk: "No Shade", wRisk: "Mud" },
                    { start: "Salas", end: "Tineo", dist: "20.2 km", lat: 43.35, lon: -6.30, water: 10, bailout: "Med", sRisk: "Heat exposure", wRisk: "Snow risk" },
                    { start: "Tineo", end: "Pola de Allande", dist: "28.2 km", lat: 43.27, lon: -6.50, water: 12, bailout: "Low", sRisk: "Heat", wRisk: "Fog/Snow" },
                    { start: "Pola de Allande", end: "La Mesa", dist: "22.8 km", lat: 43.15, lon: -6.60, water: 15, bailout: "Zero", sRisk: "Puerto del Palo Sun", wRisk: "Blizzard/Closed" },
                    { start: "La Mesa", end: "Grandas", dist: "16.8 km", lat: 43.18, lon: -6.80, water: 10, bailout: "Low", sRisk: "Knee Stress (Dam)", wRisk: "Ice on descent" },
                    { start: "Grandas", end: "A Fonsagrada", dist: "28.1 km", lat: 43.15, lon: -7.00, water: 12, bailout: "Low", sRisk: "Long Climb", wRisk: "Wind/Snow" },
                    { start: "A Fonsagrada", end: "O C√°davo", dist: "23.4 km", lat: 43.05, lon: -7.10, water: 15, bailout: "Low", sRisk: "Hospitales Route", wRisk: "Fog/Wind" },
                    { start: "O C√°davo", end: "Lugo", dist: "30.5 km", lat: 43.02, lon: -7.35, water: 8, bailout: "High", sRisk: "Long Day", wRisk: "Mud" },
                    { start: "Lugo", end: "Ferreira", dist: "26.5 km", lat: 42.95, lon: -7.65, water: 10, bailout: "Med", sRisk: "Boring/Road", wRisk: "Mud" },
                    { start: "Ferreira", end: "Melide", dist: "20.2 km", lat: 42.92, lon: -7.90, water: 5, bailout: "High", sRisk: "Heat", wRisk: "Mud" }
                ]
            },
            invierno: {
                name: "Camino de Invierno", center: [42.5, -7.5], zoom: 8, color: '#ec4899',
                stages: [
                    { start: "Ponferrada", end: "Las M√©dulas", dist: "27.2 km", lat: 42.48, lon: -6.75, water: 8, bailout: "Med", sRisk: "Heat in Mines", wRisk: "Mud" },
                    { start: "Las M√©dulas", end: "O Barco", dist: "26.4 km", lat: 42.42, lon: -6.90, water: 10, bailout: "High", sRisk: "Descent heat", wRisk: "Rain" },
                    { start: "O Barco", end: "A R√∫a", dist: "14.2 km", lat: 42.38, lon: -7.05, water: 5, bailout: "High", sRisk: "Easy day", wRisk: "Rain" },
                    { start: "A R√∫a", end: "Quiroga", dist: "26.3 km", lat: 42.42, lon: -7.20, water: 12, bailout: "Med", sRisk: "Exposed road", wRisk: "Rain" },
                    { start: "Quiroga", end: "Monforte", dist: "35.2 km", lat: 42.48, lon: -7.40, water: 15, bailout: "Med", sRisk: "Long Distance", wRisk: "Flooding" },
                    { start: "Monforte", end: "Chantada", dist: "30.4 km", lat: 42.58, lon: -7.60, water: 10, bailout: "Low", sRisk: "Faro Climb Heat", wRisk: "Mud/Ice" },
                    { start: "Chantada", end: "Rodeiro", dist: "25.8 km", lat: 42.62, lon: -7.85, water: 12, bailout: "Low", sRisk: "Faro Climb", wRisk: "Wind/Cold" },
                    { start: "Rodeiro", end: "A Laxe", dist: "27.2 km", lat: 42.70, lon: -8.05, water: 8, bailout: "Med", sRisk: "Road heat", wRisk: "Rain" },
                    { start: "A Laxe", end: "Outeiro", dist: "34.1 km", lat: 42.78, lon: -8.35, water: 10, bailout: "Low", sRisk: "Long/Boring", wRisk: "Rain" },
                    { start: "Outeiro", end: "Santiago", dist: "16.5 km", lat: 42.85, lon: -8.50, water: 5, bailout: "High", sRisk: "Easy end", wRisk: "Rain" }
                ]
            }
        };

        const icons = {
            sun: '<svg class="w-8 h-8 icon-sun" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 9c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000 1.41.996.996 0 001.41 0l1.06-1.06c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06z"/></svg>',
            partCloud: '<svg class="w-8 h-8" viewBox="0 0 24 24" fill="none"><path d="M19.36 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.64-4.96z" fill="#E8E8E8"/><circle cx="8" cy="8" r="4" fill="#FDB813"/></svg>',
            cloud: '<svg class="w-8 h-8 icon-gray" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 9.75a6 6 0 0111.573-2.226 3.75 3.75 0 014.133 4.303A4.5 4.5 0 0118 20.25H6.75a5.25 5.25 0 01-2.25-10.5Z" /></svg>',
            rain: '<svg class="w-8 h-8 icon-rain" viewBox="0 0 24 24" fill="currentColor"><path d="M4.13 12.04C3.47 12.59 3 13.43 3 14.4c0 1.99 1.61 3.6 3.6 3.6s3.6-1.61 3.6-3.6c0-.97-.47-1.81-1.13-2.36h-4.94zm9.33 0C12.8 12.59 12.33 13.43 12.33 14.4c0 1.99 1.61 3.6 3.6 3.6s3.6-1.61 3.6-3.6c0-.97-.47-1.81-1.13-2.36h-4.94zM19.36 6.04C18.67 2.59 15.64 0 12 0 9.11 0 6.6 1.64 5.35 4.04 2.34 4.36 0 6.91 0 10c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.64-4.96z"/></svg>',
            snow: '<svg class="w-8 h-8 icon-rain" viewBox="0 0 24 24" fill="currentColor"><path d="M12 24q-.625 0-1.062-.438Q10.5 23.125 10.5 22.5q0-.625.438-1.062Q11.375 21 12 21t1.062.438Q13.5 21.875 13.5 22.5q0 .625-.438 1.062Q12.625 24 12 24Zm-4-4q-.625 0-1.062-.438Q6.5 19.125 6.5 18.5q0-.625.438-1.062Q7.375 17 8 17t1.062.438Q9.5 17.875 9.5 18.5q0 .625-.438 1.062Q8.625 20 8 20Zm8 0q-.625 0-1.062-.438Q14.5 19.125 14.5 18.5q0-.625.438-1.062Q15.375 17 16 17t1.062.438Q17.5 17.875 17.5 18.5q0 .625-.438 1.062Q16.625 20 16 20Zm-8-4q-.625 0-1.062-.438Q6.5 15.125 6.5 14.5q0-.625.438-1.062Q7.375 13 8 13t1.062.438Q9.5 13.875 9.5 14.5q0 .625-.438 1.062Q8.625 16 8 16Zm8 0q-.625 0-1.062-.438Q14.5 15.125 14.5 14.5q0-.625.438-1.062Q15.375 13 16 13t1.062.438Q17.5 13.875 17.5 14.5q0 .625-.438 1.062Q16.625 16 16 16ZM6 19q-2.075 0-3.537-1.463Q1 16.075 1 14q0-2.075 1.463-3.538Q3.925 9 6 9q.575 0 1.1.088t1.025.262q.725-2.225 2.65-3.725Q12.7 4.125 15.125 4.125q2.675 0 4.525 1.863Q21.5 7.85 21.5 10.525q0 .25-.025.488-.025.237-.075.462 2.025.575 3.287 2.263Q25.95 15.425 25.95 17.5q0 2.7-1.9 4.6Q22.15 24 19.45 24H6Z" transform="scale(0.8) translate(2,-4)"/></svg>',
            fog: '<svg class="w-8 h-8 icon-gray" viewBox="0 0 24 24" fill="currentColor"><path d="M1 16v-2h22v2H1Zm4 4v-2h14v2H5Zm-3-8q-2.075 0-3.537-1.463Q1 9.075 1 7q0-2.075 1.463-3.538Q3.925 2 6 2q.575 0 1.1.088t1.025.262q.725-2.225 2.65-3.725Q12.7-2.875 15.125-2.875q2.675 0 4.525 1.863Q21.5.85 21.5 3.525q0 .25-.025.488-.025.237-.075.462 2.025.575 3.287 2.263Q25.95 8.425 25.95 10.5q0 2.7-1.9 4.6Q22.15 17 19.45 17H6Z" transform="scale(0.8) translate(2,2)"/></svg>',
            hot: '<span class="text-xl">üå°Ô∏è</span>',
            cold: '<span class="text-xl">‚ùÑÔ∏è</span>'
        };

        const weatherCodes = {
            0: { label: 'Clear', icon: icons.sun }, 1: { label: 'Sunny', icon: icons.sun },
            2: { label: 'Partly Cloudy', icon: icons.partCloud }, 3: { label: 'Overcast', icon: icons.cloud },
            45: { label: 'Foggy', icon: icons.fog }, 48: { label: 'Foggy', icon: icons.fog },
            51: { label: 'Drizzle', icon: icons.rain }, 61: { label: 'Rain', icon: icons.rain },
            63: { label: 'Rain', icon: icons.rain }, 71: { label: 'Snow', icon: icons.snow },
            95: { label: 'Storm', icon: icons.rain }
        };

        let map, markers = [], currentRouteId = 'frances', selectedStageIndex = 0, linesLayer = L.layerGroup();

        window.onload = function() {
            map = L.map('map', { zoomControl: false }).setView([42.6, -4.0], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            
            // PWA CHECK: If state exists, skip Hero
            const savedRoute = localStorage.getItem('camino_last_route');
            if(savedRoute && routes[savedRoute]) {
                switchToActiveMode(savedRoute);
                const savedStage = localStorage.getItem('camino_last_stage');
                if(savedStage) {
                    selectedStageIndex = parseInt(savedStage);
                    setTimeout(() => { if(markers[selectedStageIndex]) markers[selectedStageIndex].fire('click'); }, 500);
                }
            } else {
                showHeroMap(); // Show the colored lines
                document.getElementById('heroControls').classList.remove('hidden');
            }

            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').classList.remove('hidden'); });
            document.getElementById('installBtn').addEventListener('click', async () => { if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('installBanner').classList.add('hidden'); }});
        };

        function showHeroMap() {
            linesLayer.clearLayers();
            Object.values(routes).forEach(r => {
                const points = r.stages.map(s => [s.lat, s.lon]);
                L.polyline(points, { color: r.color || '#666', weight: 4, opacity: 0.7 }).addTo(linesLayer);
            });
            linesLayer.addTo(map);
        }

        function switchToActiveMode(routeId) {
            document.getElementById('heroControls').classList.add('hidden');
            document.getElementById('activeControls').classList.remove('hidden-transition');
            document.getElementById('mapOverlay').classList.remove('hidden-transition');
            document.getElementById('scanBtn').classList.remove('hidden-transition');
            
            linesLayer.clearLayers(); // Remove hero lines
            
            document.getElementById('routeSelect').value = routeId;
            changeRoute(); // Load pins
        }

        function enableManualMode() {
            switchToActiveMode('frances');
        }

        function changeRoute() {
            const select = document.getElementById('routeSelect');
            currentRouteId = select.value;
            const routeData = routes[currentRouteId];
            map.flyTo(routeData.center, routeData.zoom);
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            routeData.stages.forEach((stage, index) => {
                const marker = L.marker([stage.lat, stage.lon]).addTo(map);
                marker.on('click', () => {
                    selectedStageIndex = index;
                    document.getElementById('currentStageName').innerText = stage.start;
                    markers.forEach(m => { if (m._icon) m._icon.classList.remove('img-selected-pin'); });
                    if (marker._icon) marker._icon.classList.add('img-selected-pin');
                });
                markers.push(marker);
            });
            if(markers.length > 0) {
                selectedStageIndex = 0;
                document.getElementById('currentStageName').innerText = routeData.stages[0].start;
            }
        }

        function locateUser() {
            if(!navigator.geolocation) { alert("GPS not supported"); return; }
            const btn = document.querySelector('#heroControls button'); // The hero button
            const oldText = btn.innerHTML;
            btn.innerHTML = "Locating...";
            
            navigator.geolocation.getCurrentPosition((pos) => {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;
                let nearestRoute = null, nearestStageIdx = 0, minGlobDist = Infinity;

                // Find closest stage across ALL routes
                Object.keys(routes).forEach(rKey => {
                    routes[rKey].stages.forEach((stage, idx) => {
                        const d = getDistanceFromLatLonInKm(userLat, userLon, stage.lat, stage.lon);
                        if(d < minGlobDist) {
                            minGlobDist = d;
                            nearestRoute = rKey;
                            nearestStageIdx = idx;
                        }
                    });
                });

                if(minGlobDist > 50) {
                    alert("You seem far from the Camino (>50km). Switching to manual mode.");
                    enableManualMode();
                } else {
                    currentRouteId = nearestRoute;
                    selectedStageIndex = nearestStageIdx;
                    switchToActiveMode(nearestRoute);
                    // Slight delay to let map init
                    setTimeout(() => {
                        map.flyTo([routes[nearestRoute].stages[nearestStageIdx].lat, routes[nearestRoute].stages[nearestStageIdx].lon], 10);
                        if(markers[nearestStageIdx]) markers[nearestStageIdx].fire('click');
                        getTacticalForecast(); // Auto-run
                    }, 500);
                }
            }, () => {
                alert("GPS permission denied. Please select manually.");
                btn.innerHTML = oldText;
            });
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }
        function formatAMPM(dateStr) {
            let [hours, mins] = dateStr.split(':'); hours = parseInt(hours);
            let ampm = hours >= 12 ? 'PM' : 'AM'; hours = hours % 12; hours = hours ? hours : 12; 
            return `${hours}:${mins} ${ampm}`;
        }

        function generateChart(hourlyData) {
            const hours = [], temps = [], rains = [];
            for(let h=6; h<=18; h++) { hours.push(h); temps.push(Math.round(hourlyData.temperature_2m[h])); rains.push(hourlyData.precipitation[h]); }
            const w = 400, h = 100, colW = w / 13;
            const maxTemp = Math.max(...temps) + 2; const minTemp = Math.min(...temps) - 2; const range = maxTemp - minTemp || 1;
            let pathD = `M ${colW/2} ${h - ((temps[0] - minTemp)/range * 60 + 20)}`;
            const points = temps.map((t, i) => { const x = (i * colW) + (colW/2); const y = h - ((t - minTemp)/range * 60 + 20); return {x, y, t}; });
            points.forEach((p, i) => { if (i !== 0) pathD += ` L ${p.x} ${p.y}`; });
            let svg = `<svg viewBox="0 0 ${w} ${h}" class="w-full h-full overflow-visible">`;
            rains.forEach((r, i) => { if(r > 0) {
                const barH = Math.min(r * 10, 40); const x = (i * colW) + (colW/2) - 4; const y = h - barH;
                svg += `<rect x="${x}" y="${y}" width="8" height="${barH}" fill="#8ab4f8" rx="2" />`;
                if(r > 1.0) svg += `<text x="${x+4}" y="${y-4}" class="chart-label" style="fill:#1967d2">${r.toFixed(1)}</text>`;
            }});
            svg += `<path d="${pathD}" fill="none" stroke="#fdb813" stroke-width="3" stroke-linecap="round" />`;
            points.forEach((p, i) => {
                svg += `<circle cx="${p.x}" cy="${p.y}" r="3" fill="white" stroke="#fdb813" stroke-width="2" />`;
                svg += `<text x="${p.x}" y="${p.y - 8}" class="temp-label">${p.t}¬∞</text>`;
                if ((hours[i]) % 3 === 0) svg += `<text x="${p.x}" y="${h + 12}" class="chart-label">${hours[i]}:00</text>`;
            });
            return svg + `</svg>`;
        }

        async function getTacticalForecast() {
            const resultsDiv = document.getElementById('results');
            const loading = document.getElementById('loading');
            resultsDiv.innerHTML = ''; loading.classList.remove('hidden');
            localStorage.setItem('camino_last_route', currentRouteId);
            localStorage.setItem('camino_last_stage', selectedStageIndex);

            try {
                const routeData = routes[currentRouteId];
                let itinerary = [];
                for(let i=0; i<3; i++) { if (selectedStageIndex + i < routeData.stages.length) itinerary.push({ stage: routeData.stages[selectedStageIndex + i], dayOffset: i }); }
                
                const nowHour = new Date().getHours();
                const startDayOffset = (nowHour >= 17) ? 1 : 0; 
                
                const month = new Date().getMonth(); // 0-11
                const isWinter = (month >= 10 || month <= 2); 
                const isSummer = (month >= 5 && month <= 8);

                for (let i = 0; i < 3; i++) {
                    if (i >= itinerary.length) break; 
                    const current = new Date(); current.setDate(current.getDate() + startDayOffset + i); 
                    
                    let stageIndexToUse = selectedStageIndex + i; 
                    if(nowHour >= 17) stageIndexToUse += 1;
                    if(stageIndexToUse >= routeData.stages.length) break;
                    let stage = routeData.stages[stageIndexToUse];

                    let dateQuery = current.toISOString().split('T')[0];
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${stage.lat}&longitude=${stage.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,sunrise,sunset,daylight_duration&hourly=temperature_2m,apparent_temperature,precipitation,weathercode,windspeed_10m,uv_index&timezone=auto&start_date=${dateQuery}&end_date=${dateQuery}`;
                    
                    const res = await fetch(url);
                    const json = await res.json();

                    if(json.hourly) {
                        let rainSum = 0, maxRain = 0, maxWind = 0, maxUV = 0, minRealFeel = 100, maxRealFeel = -100;
                        for(let h=6; h<=15; h++) {
                            rainSum += json.hourly.precipitation[h];
                            if(json.hourly.precipitation[h] > maxRain) maxRain = json.hourly.precipitation[h];
                            if(json.hourly.windspeed_10m[h] > maxWind) maxWind = json.hourly.windspeed_10m[h];
                            if(json.hourly.uv_index[h] > maxUV) maxUV = json.hourly.uv_index[h];
                            const rf = json.hourly.apparent_temperature[h];
                            if(rf > maxRealFeel) maxRealFeel = rf;
                            if(rf < minRealFeel) minRealFeel = rf;
                        }

                        let badgeClass = "bg-gray-50 text-gray-700 border-gray-100", icon = "‚òÅÔ∏è", message = "Normal Conditions.", subMessage = "Enjoy the trail.";
                        
                        let seasonRiskText = isWinter ? stage.wRisk : (isSummer ? stage.sRisk : "");
                        
                        if (maxWind > 50) {
                            badgeClass = "bg-red-50 text-red-700 border-red-100"; icon = "‚ö†Ô∏è";
                            message = `Gale Force Winds (${Math.round(maxWind)}km/h).`; subMessage = "Avoid exposed ridges today.";
                        } 
                        else if (maxRealFeel > 32) {
                            badgeClass = "bg-orange-50 text-orange-800 border-orange-100"; icon = "üî•";
                            message = `Heat Danger (${Math.round(maxRealFeel)}¬∞).`; subMessage = "Finish walking by 13:00.";
                        }
                        else if (stage.water >= 15 && maxRealFeel > 25) {
                            badgeClass = "bg-red-50 text-red-800 border-red-100"; icon = "üíß";
                            message = "CRITICAL HYDRATION."; subMessage = `No water for ${stage.water}km in heat. Carry 3L.`;
                        }
                        else if (stage.bailout === "Zero" && (maxRain > 5 || maxWind > 40)) {
                            badgeClass = "bg-red-900 text-white border-red-900"; icon = "‚õî";
                            message = "NO BAILOUT."; subMessage = "Remote stage + Bad Weather = Do not start.";
                        }
                        else if (isWinter && minRealFeel < 2) {
                            badgeClass = "bg-blue-50 text-blue-800 border-blue-100"; icon = "‚ùÑÔ∏è";
                            message = "Freezing Morning."; subMessage = seasonRiskText || "Wear layers.";
                        }
                        else if (isSummer && stage.sRisk && stage.sRisk.includes("Heat")) {
                             badgeClass = "bg-orange-50 text-orange-800 border-orange-100"; icon = "‚òÄÔ∏è";
                             message = seasonRiskText; subMessage = "Hydrate frequently.";
                        }
                        else if (rainSum < 0.2) {
                            badgeClass = "bg-green-50 text-green-700 border-green-100"; icon = "‚úÖ";
                            message = "Perfect Walking Weather."; subMessage = seasonRiskText || "Dry trail.";
                        } else {
                            message = "Light Rain Expected."; subMessage = "Keep poncho handy.";
                        }

                        const d = json.daily;
                        const sunrise = formatAMPM(d.sunrise[0].split('T')[1].slice(0,5));
                        const dlHrs = Math.floor(d.daylight_duration[0] / 3600);
                        const chartSVG = generateChart(json.hourly);
                        const wInfo = weatherCodes[d.weathercode[0]] || { label: 'Unknown', icon: icons.cloud };

                        const html = `
                            <div class="card-tactical p-4 mb-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-[10px] font-bold bg-[#1967d2] text-white px-2 py-0.5 rounded uppercase">${current.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' })}</span>
                                            <span class="text-[10px] text-gray-400 uppercase tracking-wide truncate max-w-[120px]">${stage.start} ‚Üí ${stage.end}</span>
                                        </div>
                                        <div class="flex items-center gap-3 text-[10px] text-gray-500 font-bold mt-1 mb-2">
                                            <span class="bg-gray-100 px-1.5 rounded text-gray-700">${stage.dist}</span>
                                            <span class="flex items-center gap-1"><svg class="w-3 h-3 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg> ${sunrise}</span>
                                            <span>${dlHrs}h Light</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex justify-end mb-1">${wInfo.icon}</div>
                                        <div class="text-2xl font-bold text-gray-800">${Math.round(d.temperature_2m_max[0])}¬∞</div>
                                        <div class="text-xs text-blue-500 font-bold">${Math.round(d.temperature_2m_min[0])}¬∞</div>
                                    </div>
                                </div>
                                <div class="${badgeClass} p-3 rounded-lg text-xs border flex items-start gap-3 shadow-sm mb-3">
                                    <div class="text-xl pt-0.5">${icon}</div>
                                    <div>
                                        <div class="font-bold text-base leading-tight">${message}</div>
                                        <div class="opacity-90 font-medium mt-0.5">${subMessage}</div>
                                    </div>
                                </div>
                                <div class="chart-container">${chartSVG}</div>
                            </div>
                        `;
                        resultsDiv.innerHTML += html;
                    }
                }
            } catch (e) { console.error(e); resultsDiv.innerHTML = `<div class="text-red-400 text-center font-bold py-10">Error. Check connection.</div>`; } 
            finally { loading.classList.add('hidden'); }
        }
    </script>
</body>
</html>
